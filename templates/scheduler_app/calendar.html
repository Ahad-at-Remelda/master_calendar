{% load static %}
{% load socialaccount %}
{% load tz %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --background: #ffffff; --foreground: #374151; --card: #f8fafc;
            --card-foreground: #1f2937; --primary: #374151; --primary-foreground: #ffffff;
            --secondary: #6366f1; --secondary-foreground: #ffffff; --accent: #6366f1;
            --accent-foreground: #ffffff; --border: #e5e7eb; --sidebar: #f8fafc;
            --sidebar-foreground: #374151; --sidebar-border: #e5e7eb; --radius: 0.5rem;
            --google-blue: #4285f4; --google-blue-hover: #3367d6; --microsoft-blue: #0078d4;
            --microsoft-blue-hover: #106ebe; --booking-orange: #f97316; --booking-orange-hover: #ea580c;
        }
        body { font-family: 'Source Sans Pro', sans-serif; background: var(--background); color: var(--foreground); line-height: 1.6; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Playfair Display', serif; font-weight: 600; }
        .sidebar { background: var(--sidebar); border-right: 1px solid var(--sidebar-border); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: all 0.3s ease-in-out; position: relative; z-index: 1000; overflow-x: hidden; overflow-y: auto; }
        .sidebar.collapsed { width: 0; min-width: 0; opacity: 0; visibility: hidden; }
        .sidebar-toggle { position: fixed; top: 20px; left: 20px; z-index: 1001; background: var(--primary); color: var(--primary-foreground); border: none; border-radius: var(--radius); padding: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; cursor: pointer; }
        .sidebar-toggle:hover { background: var(--secondary); transform: scale(1.05); }
        .sidebar-toggle.sidebar-open { top: 15px; left: 285px; }
        .sidebar-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--sidebar-foreground); font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: var(--radius); transition: background 0.2s ease; }
        .sidebar-close:hover { background: var(--border); }
        .sidebar h4 { color: var(--primary); font-weight: 700; margin-bottom: 1.5rem; }
        .sidebar h5 { font-size: 0.875rem; font-weight: 600; text-transform: uppercase; color: var(--sidebar-foreground); margin-top: 1.5rem; margin-bottom: 0.75rem; letter-spacing: 0.05em; }
        .list-group-item { border: none; padding: 0.75rem 1rem; border-radius: var(--radius); transition: all 0.2s ease; background: transparent; margin-bottom: 0.25rem; }
        .list-group-item:hover { background: var(--border); transform: translateX(4px); }
        .list-group-item.active { background: var(--accent); color: var(--accent-foreground); }
        .page-wrapper { display: grid; grid-template-columns: 320px 1fr; height: 100vh; transition: grid-template-columns 0.3s ease; }
        .page-wrapper.sidebar-collapsed { grid-template-columns: 0fr 1fr; }
        .main-content { flex-grow: 1; overflow-y: auto; background: var(--background); padding: 2.5rem; min-width: 0; }
        .calendar-header { margin-bottom: 2.5rem; padding: 1.5rem 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1.25rem; width: 100%; align-items: start; }
        .calendar-day { min-height: 140px; border: 1px solid var(--border); padding: 0.75rem; position: relative; background: var(--card); display: flex; flex-direction: column; border-radius: var(--radius); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); transition: all 0.2s ease; overflow: hidden; }
        .calendar-day-header { font-weight: 600; color: var(--card-foreground); margin-bottom: 0.5rem; font-size: 1rem; flex-shrink: 0; }
        .event-list { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; gap: 0.25rem; }
        .event { display: flex; flex-direction: column; font-size: 0.7rem; margin-bottom: 0; padding: 0.4rem 0.5rem; border-radius: 4px; color: white; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); min-height: 28px; position: relative; flex-shrink: 0; }
        .more-events { font-size: 0.7rem; color: var(--foreground); padding: 0.25rem 0.5rem; background: var(--border); border-radius: 4px; cursor: pointer; text-align: center; font-weight: 500; margin-top: 0.25rem; flex-shrink: 0; }
        .more-events:hover { background: var(--primary); color: white; }
        .event-time { font-size: 0.6rem; font-weight: 600; opacity: 0.9; margin-bottom: 0.1rem; line-height: 1; }
        .event-title { font-size: 0.7rem; font-weight: 500; line-height: 1.2; word-wrap: break-word; overflow-wrap: break-word; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        .event-icon { position: absolute; top: 0.5rem; right: 0.5rem; width: 12px; height: 12px; border-radius: 50%; background-color: rgba(255,255,255,0.4); }
        .google-event { background: linear-gradient(135deg, #34a853, #137333); } .local-event { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .microsoft-event { background: linear-gradient(135deg, #0078d4, #106ebe); } .booked_meeting-event { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .time-slot-container { display: grid; grid-template-columns: 80px 1fr; gap: 1rem; height: 100%; min-height: 80vh; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .time-labels { display: flex; flex-direction: column; gap: 0; background: var(--card); }
        .time-label { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 500; color: var(--foreground); border-bottom: 1px solid var(--border); background: var(--card); }
        .time-slots-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); }
        .time-slot { height: 60px; background: white; border-bottom: 1px solid var(--border); border-right: 1px solid rgba(229, 231, 235, 0.5); position: relative; padding: 2px; }
        .time-slot:hover { background: #f8fafc; }
        .time-slot-event { position: absolute; left: 2px; right: 2px; top: 2px; bottom: 2px; border-radius: 4px; padding: 4px 6px; font-size: 0.7rem; font-weight: 500; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; justify-content: center; }
        .time-slot-event:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .day-time-slot-container { display: grid; grid-template-columns: 100px 1fr; gap: 1.5rem; margin-top: 1.5rem; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .day-time-slot { height: 80px; background: white; border-bottom: 1px solid var(--border); position: relative; padding: 0.5rem; margin-bottom: 0; }
        .day-time-slot:hover { background: #f8fafc; }
        .day-time-label { height: 80px; display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--foreground); background: var(--card); border-bottom: 1px solid var(--border); margin-bottom: 0; }
        .day-name { background: var(--primary); color: var(--primary-foreground); padding: 1rem; text-align: center; font-weight: 600; font-size: 0.9rem; border-radius: var(--radius); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .btn-modern { border-radius: var(--radius); font-weight: 500; padding: 0.75rem 1.5rem; transition: all 0.2s ease; border: none; font-family: 'Source Sans Pro', sans-serif; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-modern:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-decoration: none; }
        .btn-primary-modern { background: var(--primary); color: var(--primary-foreground); }
        .btn-primary-modern:hover { background: var(--secondary); color: var(--secondary-foreground); }
        .btn-secondary-modern { background: var(--booking-orange); color: white; }
        .btn-secondary-modern:hover { background: var(--booking-orange-hover); color: white; }
        .btn-outline-modern { background: transparent; border: 2px solid var(--border); color: var(--foreground); }
        .btn-outline-modern:hover { background: var(--border); color: var(--foreground); }
        .btn-google { background: var(--google-blue); color: white; border: none; }
        .btn-google:hover { background: var(--google-blue-hover); color: white; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(66, 133, 244, 0.3); }
        .btn-microsoft { background: var(--microsoft-blue); color: white; border: none; }
        .btn-microsoft:hover { background: var(--microsoft-blue-hover); color: white; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 120, 212, 0.3); }
        .btn-nav { background: white; border: 2px solid var(--border); color: var(--foreground); padding: 0.75rem 1.25rem; border-radius: var(--radius); font-weight: 500; transition: all 0.2s ease; text-decoration: none; display: inline-flex; align-items: center; }
        .btn-nav:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-decoration: none; }
        .modal-content { border-radius: var(--radius); border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .modal-header { background: var(--card); border-bottom: 1px solid var(--border); border-radius: var(--radius) var(--radius) 0 0; }
        .modal-title { color: var(--primary); font-weight: 600; }
        @media (max-width: 768px) {
            .page-wrapper { grid-template-columns: 1fr; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 320px; z-index: 1000; }
            .sidebar.collapsed { transform: translateX(-100%); width: 320px; opacity: 1; visibility: visible; }
            .main-content { padding: 1.5rem; } .calendar-header { margin-bottom: 1.5rem; padding: 1rem 0; }
            .calendar-grid { gap: 0.75rem; } .calendar-day { min-height: 120px; padding: 0.75rem; }
            .time-slot-container { grid-template-columns: 60px 1fr; gap: 0.5rem; }
            .time-label { height: 50px; font-size: 0.7rem; } .time-slot { height: 50px; }
            .sidebar-toggle.sidebar-open { left: 20px; top: 20px; }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar"><i class="bi bi-list"></i></button>

    <div class="page-wrapper" id="pageWrapper">
        <div class="sidebar" id="sidebar">
            <div class="p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2>Lets <i class="fa-solid fa-clock"></i> Sync</h2>
                    <button class="sidebar-close d-md-none" id="sidebarClose">&times;</button>
                </div>
                <div class="mb-3"><span class="text-muted">Logged in as:</span> <strong class="text-primary">{{ user.username }}</strong></div>
                <hr class="my-4">
                <h5>My Calendars & Filters</h5>
                <div class="list-group list-group-flush mb-4">
                    <label class="list-group-item d-flex gap-3 align-items-center"><input class="form-check-input flex-shrink-0 calendar-filter" type="checkbox" data-filter-type="source" data-filter-value="local" checked><span><i class="bi bi-calendar3 text-info me-2"></i> Local Events</span></label>
                    <label class="list-group-item d-flex gap-3 align-items-center"><input class="form-check-input flex-shrink-0 calendar-filter" type="checkbox" data-filter-type="source" data-filter-value="booked_meeting" checked><span><i class="bi bi-person-check-fill me-2" style="color: #8b5cf6;"></i> Booked Meetings</span></label>
                    {% for account in google_accounts %}<div class="list-group-item d-flex justify-content-between align-items-center"><label class="d-flex gap-3 align-items-center flex-grow-1" style="cursor: pointer;"><input class="form-check-input flex-shrink-0 calendar-filter" type="checkbox" data-filter-type="account" data-filter-value="{{ account.id }}" checked><span><i class="bi bi-google text-success me-2"></i> <small>{{ account.email }}</small></span></label><a href="{% url 'disconnect_social_account' account.id %}" class="btn btn-sm btn-outline-danger ms-2"><i class="bi bi-trash"></i></a></div>{% endfor %}
                    {% for account in microsoft_accounts %}<div class="list-group-item d-flex justify-content-between align-items-center"><label class="d-flex gap-3 align-items-center flex-grow-1" style="cursor: pointer;"><input class="form-check-input flex-shrink-0 calendar-filter" type="checkbox" data-filter-type="account" data-filter-value="{{ account.id }}" checked><span><i class="bi bi-microsoft text-primary me-2"></i> <small>{{ account.email }}</small></span></label><a href="{% url 'disconnect_social_account' account.id %}" class="btn btn-sm btn-outline-danger ms-2"><i class="bi bi-trash"></i></a></div>{% endfor %}
                </div>
                <h5>Connect New Account</h5>
                <div class="d-grid gap-2 mb-4"><a href="{% provider_login_url 'google' process='connect' %}" class="btn btn-modern btn-google"><i class="bi bi-google me-2"></i> Connect Google Account</a><a href="{% provider_login_url 'microsoft' process='connect' %}" class="btn btn-modern btn-microsoft"><i class="bi bi-microsoft me-2"></i> Connect Outlook Account</a></div>
                <h5>Booking & Sharing</h5>
                <div class="d-grid gap-2 mb-3"><a class="btn btn-modern btn-outline-modern" href="{% url 'user_settings' %}"><i class="bi bi-gear-fill me-2"></i> Booking Settings</a></div>
                {% if sharing_url %}<label for="sharing-url-input" class="form-label"><small>Your Public Booking Link:</small></label><div class="input-group mb-3"><input type="text" id="sharing-url-input" class="form-control form-control-sm" value="{{ sharing_url }}" readonly><button class="btn btn-outline-secondary" type="button" id="copy-url-btn" title="Copy to clipboard"><i class="bi bi-clipboard"></i></button></div>{% else %}<p class="text-muted small">An error occurred generating your sharing link.</p>{% endif %}
                <div class="d-grid gap-2">
                    <a class="btn btn-modern btn-secondary-modern" href="{% url 'add_event' %}"><i class="bi bi-plus-circle-fill me-2"></i> Add Local Event</a>
                    <a href="{% url 'home' %}" class="list-group-item list-group-item-action"><i class="bi bi-calendar3 me-2"></i> Main Calendar</a>
                    <a href="{% url 'sync_calendars' %}" class="list-group-item list-group-item-action"><i class="bi bi-arrow-repeat me-2"></i> Sync Calendars</a>
                    <form action="{% url 'account_logout' %}" method="post" class="d-grid">{% csrf_token %}<button type="submit" class="btn btn-modern btn-outline-modern"><i class="bi bi-box-arrow-right me-2"></i> Logout</button></form>
                </div>
            </div>
        </div>
        
        <div class="main-content"
             data-current-year="{{ year }}" 
             data-current-month="{{ month }}">
            <div class="calendar-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group"><a href="{{ prev_url }}" class="btn btn-nav"><i class="bi bi-arrow-left me-2"></i> Previous</a><a href="{{ next_url }}" class="btn btn-nav">Next <i class="bi bi-arrow-right ms-2"></i></a></div>
                    <h1 class="mb-0">{{ header_title }}</h1>
                    <div class="btn-group"><a href="{{ today_day_url }}" class="btn btn-modern {% if view_mode == 'day' %}btn-primary-modern{% else %}btn-outline-modern{% endif %}">Day</a><a href="{{ today_week_url }}" class="btn btn-modern {% if view_mode == 'week' %}btn-primary-modern{% else %}btn-outline-modern{% endif %}">Week</a><a href="{{ today_month_url }}" class="btn btn-modern {% if view_mode == 'month' %}btn-primary-modern{% else %}btn-outline-modern{% endif %}">Month</a></div>
                </div>
            </div>
            
            {% if view_mode == 'month' %}
                <div class="calendar-grid mb-4"><div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div><div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div></div>
                <div class="calendar-grid">
                    {% for data in days_data %}
                        <div class="{% if data.is_placeholder %}placeholder-day{% else %}calendar-day{% endif %}" data-day-number="{{ data.day }}">
                            {% if not data.is_placeholder %}
                                <div class="calendar-day-header">{{ data.day }}</div>
                                <div class="event-list">
                                    {% for event in data.events %}
                                        <div class="event {{ event.source }}-event" 
                                             data-event-id="{{ event.id }}"
                                             data-event-source="{{ event.source }}"
                                             data-social-account-id="{{ event.social_account.id|default_if_none:'local' }}">
                                            <div class="event-time">{% if event.start_time %}{{ event.start_time|localtime|date:"g:i A" }}{% else %}All Day{% endif %}</div>
                                            <div class="event-title">{{ event.title|default:"Untitled Event" }}</div>
                                            <div class="event-icon"></div>
                                        </div>
                                    {% endfor %}
                                    <div class="more-events" style="display: none;"></div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if view_mode == 'week' %}
                <div class="calendar-grid mb-4">{% for day in week_days %}<div class="day-name">{{ day.date|date:"D j" }}</div>{% endfor %}</div>
                <div class="time-slot-container">
                    <div class="time-labels">{% for i in "x"|ljust:24 %}<div class="time-label">{% if forloop.counter0 == 0 %}12 AM{% elif forloop.counter0 < 12 %}{{ forloop.counter0 }} AM{% elif forloop.counter0 == 12 %}12 PM{% else %}{{ forloop.counter0|add:"-12" }} PM{% endif %}</div>{% endfor %}</div>
                    <div class="time-slots-grid">
                        {% for day_data in week_days %}
                            {% for hour_index in "x"|ljust:24 %}
                                <div class="time-slot" data-day="{{ day_data.date|date:'Y-m-d' }}" data-hour="{{ forloop.counter0 }}">
                                    {% for event in day_data.events %}
                                        {% if event.start_time %}
                                            {% with event_hour=event.start_time|localtime|date:'H'|add:0 %}
                                                {% if event_hour == forloop.parentloop.counter0 %}
                                                    <div class="time-slot-event {{ event.source }}-event" 
                                                         data-event-id="{{ event.id }}"
                                                         data-event-source="{{ event.source }}"
                                                         data-social-account-id="{{ event.social_account.id|default_if_none:'local' }}"
                                                         title="{{ event.title|default:'Untitled Event' }} - {{ event.start_time|localtime|date:'g:i A' }}">
                                                        <div style="font-size: 0.6rem; opacity: 0.9;">{{ event.start_time|localtime|date:"g:i A" }}</div>
                                                        <div style="font-size: 0.7rem;">{{ event.title|default:"Untitled"|truncatechars:12 }}</div>
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        {% elif forloop.parentloop.counter0 == 0 %}
                                            <div class="time-slot-event {{ event.source }}-event" 
                                                 data-event-id="{{ event.id }}"
                                                 data-event-source="{{ event.source }}"
                                                 data-social-account-id="{{ event.social_account.id|default_if_none:'local' }}"
                                                 title="{{ event.title|default:'Untitled Event' }} - All Day">
                                                <div style="font-size: 0.6rem; opacity: 0.9;">All Day</div>
                                                <div style="font-size: 0.7rem;">{{ event.title|default:"Untitled"|truncatechars:12 }}</div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if view_mode == 'day' %}
                <div class="day-time-slot-container">
                    <div>{% for i in "x"|ljust:24 %}<div class="day-time-label">{% if forloop.counter0 == 0 %}12:00 AM{% elif forloop.counter0 < 12 %}{{ forloop.counter0 }}:00 AM{% elif forloop.counter0 == 12 %}12:00 PM{% else %}{{ forloop.counter0|add:"-12" }}:00 PM{% endif %}</div>{% endfor %}</div>
                    <div>
                        {% for hour_index in "x"|ljust:24 %}
                            <div class="day-time-slot" data-hour="{{ forloop.counter0 }}">
                                {% for event in events %}
                                    {% if event.start_time %}
                                        {% with event_hour=event.start_time|localtime|date:'H'|add:0 %}
                                            {% if event_hour == forloop.parentloop.counter0 %}
                                                <div class="event {{ event.source }}-event" 
                                                     data-event-id="{{ event.id }}"
                                                     data-event-source="{{ event.source }}"
                                                     data-social-account-id="{{ event.social_account.id|default_if_none:'local' }}">
                                                    <div class="event-time">{{ event.start_time|localtime|date:"g:i A" }}</div>
                                                    <div class="event-title">{{ event.title|default:"Untitled Event" }}</div><div class="event-icon"></div>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% elif forloop.parentloop.counter0 == 0 %}
                                        <div class="event {{ event.source }}-event" 
                                             data-event-id="{{ event.id }}"
                                             data-event-source="{{ event.source }}"
                                             data-social-account-id="{{ event.social_account.id|default_if_none:'local' }}">
                                            <div class="event-time">All Day</div>
                                            <div class="event-title">{{ event.title|default:"Untitled Event" }}</div><div class="event-icon"></div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Main Modal for Single Event Details -->
    <div class="modal fade" id="eventDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body-content"></div>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for showing all events for a day -->
    <div class="modal fade" id="dayEventsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="day-events-modal-title">All Events</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="day-events-modal-body"></div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarContainer = document.querySelector('.main-content');
        const sidebar = document.getElementById('sidebar');
        const pageWrapper = document.getElementById('pageWrapper');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');

        function toggleSidebar() {
            sidebar.classList.toggle('collapsed');
            pageWrapper.classList.toggle('sidebar-collapsed');
            sidebarToggle.classList.toggle('sidebar-open');
            const icon = sidebarToggle.querySelector('i');
            icon.className = sidebar.classList.contains('collapsed') ? 'bi bi-list' : 'bi bi-x';
        }
        if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
        if (sidebarClose) sidebarClose.addEventListener('click', toggleSidebar);

        function setupCalendarInteractions() {
            const eventDetailModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
            const dayEventsModal = new bootstrap.Modal(document.getElementById('dayEventsModal'));

            calendarContainer.addEventListener('click', function(e) {
                const eventEl = e.target.closest('.event, .time-slot-event');
                if (eventEl && eventEl.dataset.eventId) {
                    showSingleEventModal(eventEl.dataset.eventId, eventDetailModal);
                }
                const moreEventsEl = e.target.closest('.more-events');
                if (moreEventsEl) {
                    const dayEl = moreEventsEl.closest('.calendar-day');
                    if (dayEl) {
                        showAllDayEventsModal(dayEl, dayEventsModal);
                    }
                }
            });

            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                const eventList = dayEl.querySelector('.event-list');
                if (!eventList) return;
                const allEvents = eventList.querySelectorAll('.event');
                const moreEventsButton = eventList.querySelector('.more-events');
                const maxVisible = 2;
                if (allEvents.length > maxVisible) {
                    for (let i = maxVisible; i < allEvents.length; i++) {
                        allEvents[i].style.display = 'none';
                    }
                    if (moreEventsButton) {
                        moreEventsButton.innerText = `${allEvents.length - maxVisible} more`;
                        moreEventsButton.style.display = 'block';
                    }
                }
            });
        }

        function showSingleEventModal(eventId, modalInstance) {
            fetch(`/api/event/${eventId}/`)
                .then(response => response.json())
                .then(data => {
                    const formatDateTime = (iso) => iso ? new Date(iso).toLocaleString() : "All-day";
                    let html = `
                        <p><strong>Description:</strong> ${data.description || 'N/A'}</p>
                        <p><strong>Starts:</strong> ${formatDateTime(data.start_time)}</p>
                        <p><strong>Ends:</strong> ${formatDateTime(data.end_time)}</p>
                        <p><strong>Location:</strong> ${data.location || 'N/A'}</p>
                        ${data.meeting_link ? `<p><strong>Meeting Link:</strong> <a href="${data.meeting_link}" target="_blank">Join Meeting</a></p>` : ''}
                        <p><small><strong>Source:</strong> ${data.source} (${data.account_email || 'Local'})</small></p>
                    `;
                    document.getElementById('modal-title').textContent = data.title || "Event Details";
                    document.getElementById('modal-body-content').innerHTML = html;
                    modalInstance.show();
                });
        }

        function showAllDayEventsModal(dayElement, dayModalInstance) {
            const dayNumber = dayElement.dataset.dayNumber;
            const year = calendarContainer.dataset.currentYear;
            const monthName = new Date(year, calendarContainer.dataset.currentMonth - 1).toLocaleString('default', { month: 'long' });
            
            document.getElementById('day-events-modal-title').textContent = `Events for ${monthName} ${dayNumber}`;
            const eventListContainer = document.getElementById('day-events-modal-body');
            eventListContainer.innerHTML = '';
            
            const allEventsInDay = dayElement.querySelectorAll('.event-list .event');
            const eventListGroup = document.createElement('div');
            eventListGroup.className = 'list-group';

            allEventsInDay.forEach(eventNode => {
                const clonedEvent = eventNode.cloneNode(true);
                clonedEvent.style.display = 'flex';
                clonedEvent.classList.add('list-group-item', 'list-group-item-action');
                clonedEvent.addEventListener('click', () => {
                    const eventId = clonedEvent.dataset.eventId;
                    dayModalInstance.hide();
                    setTimeout(() => {
                        const detailModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
                        showSingleEventModal(eventId, detailModal);
                    }, 500);
                });
                eventListGroup.appendChild(clonedEvent);
            });
            eventListContainer.appendChild(eventListGroup);
            dayModalInstance.show();
        }

        function updateEventVisibility() {
            const filterCheckboxes = document.querySelectorAll('.calendar-filter');
            const visibleSources = [];
            const visibleAccounts = [];
            filterCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const filterType = checkbox.dataset.filterType;
                    const filterValue = checkbox.dataset.filterValue;
                    if (filterType === 'source') {
                        visibleSources.push(filterValue);
                    } else if (filterType === 'account') {
                        visibleAccounts.push(filterValue);
                    }
                }
            });

            document.querySelectorAll('[data-event-id]').forEach(eventEl => {
                const eventSource = eventEl.dataset.eventSource;
                const socialAccountId = eventEl.dataset.socialAccountId;
                
                let isVisible = false;
                if (eventSource === 'local' && visibleSources.includes('local')) {
                    isVisible = true;
                } else if (eventSource === 'booked_meeting' && visibleSources.includes('booked_meeting')) {
                    isVisible = true;
                } else if (visibleAccounts.includes(socialAccountId)) {
                    isVisible = true;
                }
                eventEl.style.display = isVisible ? 'flex' : 'none';
            });
        }
        
        {% if user.is_authenticated %}
            const userSocket = new WebSocket((window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws/calendar/");
            userSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                if (data.update === "calendar_changed") {
                    console.log("WebSocket: Real-time update received!");
                    fetch(window.location.href).then(response => response.text()).then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newMainContent = doc.querySelector('.main-content');
                        if (newMainContent) {
                            calendarContainer.innerHTML = newMainContent.innerHTML;
                            setupCalendarInteractions();
                        }
                    });
                }
            };
        {% endif %}
        
        setupCalendarInteractions();
    });
    </script>
</body>
</html>